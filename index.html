<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Image Viewer with Adjustments</title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            overscroll-behavior: none; /* Prevent pull-to-refresh */
            touch-action: none; /* Prevent default touch actions */
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 100%;
        }
        @media (min-width: 768px) {
            .container {
                flex-direction: row;
            }
        }
        .canvas-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            touch-action: none;
        }
        #imageCanvas {
            width: 100%;
            height: auto;
            cursor: move;
            touch-action: none;
        }
        .slider-container {
            height: 500px;
            display: flex;
            align-items: center;
        }
        input[type="range"].vertical {
            transform: rotate(270deg);
            width: 500px;
            height: 50px;
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
            width: 100%;
            max-width: 500px;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }
        .control-label {
            min-width: 100px;
            font-weight: bold;
        }
        .control-slider {
            flex-grow: 1;
            height: 30px; /* Larger touch target */
        }
        .control-value {
            min-width: 50px;
            text-align: right;
            font-family: monospace;
        }
        /* Mobile-friendly slider styles */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            border-radius: 5px;
            height: 10px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            background: #4CAF50;
            border-radius: 50%;
            cursor: pointer;
        }
        .error-message {
            color: red;
            font-size: 18px;
            text-align: center;
            margin: 20px;
        }
    </style>
</head>
<body>
    <!-- Previous HTML remains the same -->
    <script>
        // Previous variables and functions remain the same until setupCanvasEvents

        function setupCanvasEvents() {
            const canvas = document.getElementById('imageCanvas');
            let lastTouchDistance = 0;
            let isGesturing = false;

            // Touch start event
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (e.touches.length === 1) {
                    isDragging = true;
                    lastX = e.touches[0].clientX;
                    lastY = e.touches[0].clientY;
                } else if (e.touches.length === 2) {
                    // Start of pinch-to-zoom
                    isGesturing = true;
                    lastTouchDistance = getTouchDistance(e.touches);
                }
            }, { passive: false });

            // Touch move event
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (isDragging && e.touches.length === 1) {
                    // Single touch - pan
                    const touch = e.touches[0];
                    const deltaX = touch.clientX - lastX;
                    const deltaY = touch.clientY - lastY;
                    
                    offsetX += deltaX;
                    offsetY += deltaY;
                    
                    lastX = touch.clientX;
                    lastY = touch.clientY;
                    
                    displayImage(images[currentImageIndex]);
                } else if (isGesturing && e.touches.length === 2) {
                    // Pinch-to-zoom
                    const currentDistance = getTouchDistance(e.touches);
                    const delta = currentDistance - lastTouchDistance;
                    
                    const zoomFactor = 0.005;
                    const oldScale = scale;
                    scale = Math.max(0.1, Math.min(5, scale * (1 + delta * zoomFactor)));
                    
                    // Get the center point between the two touches
                    const centerX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                    const centerY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                    
                    // Adjust offset to zoom towards center point
                    const rect = canvas.getBoundingClientRect();
                    const zoomPointX = centerX - rect.left - canvas.width/2 - offsetX;
                    const zoomPointY = centerY - rect.top - canvas.height/2 - offsetY;
                    
                    offsetX += zoomPointX * (1 - scale/oldScale);
                    offsetY += zoomPointY * (1 - scale/oldScale);
                    
                    lastTouchDistance = currentDistance;
                    displayImage(images[currentImageIndex]);
                }
            }, { passive: false });

            // Touch end event
            canvas.addEventListener('touchend', (e) => {
                isDragging = false;
                isGesturing = false;
            });

            // Touch cancel event
            canvas.addEventListener('touchcancel', (e) => {
                isDragging = false;
                isGesturing = false;
            });

            // Mouse events (keep existing mouse events for desktop compatibility)
            canvas.addEventListener('mousedown', (e) => {
                if (e.button === 0) {
                    isDragging = true;
                    lastX = e.offsetX;
                    lastY = e.offsetY;
                }
            });

            canvas.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaX = e.offsetX - lastX;
                    const deltaY = e.offsetY - lastY;
                    
                    offsetX += deltaX;
                    offsetY += deltaY;
                    
                    lastX = e.offsetX;
                    lastY = e.offsetY;
                    
                    displayImage(images[currentImageIndex]);
                }
            });

            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });

            canvas.addEventListener('mouseleave', () => {
                isDragging = false;
            });

            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                
                const zoomFactor = 0.1;
                const delta = e.deltaY > 0 ? -zoomFactor : zoomFactor;
                const oldScale = scale;
                
                scale = Math.max(0.1, Math.min(5, scale * (1 + delta)));
                
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                const zoomPointX = mouseX - canvas.width/2 - offsetX;
                const zoomPointY = mouseY - canvas.height/2 - offsetY;
                
                offsetX += zoomPointX * (1 - scale/oldScale);
                offsetY += zoomPointY * (1 - scale/oldScale);
                
                displayImage(images[currentImageIndex]);
            });
        }

        // Helper function to calculate distance between two touch points
        function getTouchDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // Add swipe detection for image navigation
        function setupSwipeEvents() {
            const canvas = document.getElementById('imageCanvas');
            let touchStartX = 0;
            let touchStartY = 0;
            let touchStartTime = 0;

            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                    touchStartTime = Date.now();
                }
            });

            canvas.addEventListener('touchend', (e) => {
                if (e.changedTouches.length === 1) {
                    const touchEndX = e.changedTouches[0].clientX;
                    const touchEndY = e.changedTouches[0].clientY;
                    const touchEndTime = Date.now();

                    const deltaX = touchEndX - touchStartX;
                    const deltaY = touchEndY - touchStartY;
                    const deltaTime = touchEndTime - touchStartTime;

                    // Check if it's a swipe (fast enough and long enough)
                    if (deltaTime < 300) {
                        const swipeLength = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                        if (swipeLength > 50) {
                            // Determine if it's mostly horizontal
                            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                                const slider = document.getElementById('imageSlider');
                                if (deltaX > 0 && currentImageIndex > 0) {
                                    // Swipe right - previous image
                                    currentImageIndex--;
                                    slider.value = currentImageIndex;
                                    displayImage(images[currentImageIndex]);
                                } else if (deltaX < 0 && currentImageIndex < images.length - 1) {
                                    // Swipe left - next image
                                    currentImageIndex++;
                                    slider.value = currentImageIndex;
                                    displayImage(images[currentImageIndex]);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Modify init() to include swipe events
        async function init() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const binFileName = urlParams.get('file');
                
                const filePath = binFileName 
                    ? `Images/${binFileName}.bin`
                    : 'Images/output.bin';
                
                const buffer = await fetchBinFile(filePath);
                images = await loadImagesFromBuffer(buffer);
                
                if (images.length > 0) {
                    const slider = document.getElementById('imageSlider');
                    slider.max = images.length - 1;
                    displayImage(images[0]);
                    
                    slider.addEventListener('input', (e) => {
                        currentImageIndex = parseInt(e.target.value);
                        displayImage(images[currentImageIndex]);
                    });

                    setupCanvasEvents();
                    setupAdjustmentSliders();
                    setupKeyboardEvents();
                    setupSwipeEvents();
                }
            } catch (error) {
                showError('Error: The requested image file was not found or could not be loaded.');
            }
        }

        window.onload = init;
    </script>
</body>
</html>
